name: DAST - OWASP ZAP

on:
  workflow_dispatch:

jobs:
  zap_scan:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: '18'

      - name: Install deps
        run: npm ci

      - name: Start app
        run: npm start &

      - name: Wait for server
        run: |
          for i in {1..15}; do
            curl -sSf http://localhost:3000 && break || sleep 1
          done

      - name: Install tools
        run: |
          sudo apt-get update
          sudo apt-get install -y --no-install-recommends \
            openjdk-11-jre-headless wget tar gzip python3 python3-pip netcat-openbsd jq

      - name: Query releases and download ZAP
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          set -euo pipefail
          API_URL=https://api.github.com/repos/zaproxy/zaproxy/releases/latest
          http_code=$(curl -sS -H "Accept: application/vnd.github+json" -H "Authorization: Bearer $GITHUB_TOKEN" -w "%{http_code}" -o /tmp/releases.json "$API_URL" || true)
          if [ "$http_code" != "200" ]; then
            echo "GitHub API returned $http_code"
            head -c 400 /tmp/releases.json || true
            exit 1
          fi
          # Find any tar.gz asset (linux/unix) robustly even if JSON shape varies
          URL=$(jq -r '.. | objects | select(.name? and (.name|test("\\.tar\\.gz$";"i"))) | .browser_download_url' /tmp/releases.json | head -n1 || true)
          if [ -z "${URL:-}" ]; then
            echo "No tar.gz asset found in release JSON"
            # print possible asset names (robust fallback)
            jq -r '.. | objects | select(.name?) | .name' /tmp/releases.json | sed -n '1,200p' || true
            exit 1
          fi
          echo "Downloading $URL"
          curl -fSL -o /tmp/zap.tar.gz "$URL"
          sudo mkdir -p /opt/zap
          sudo tar -xzf /tmp/zap.tar.gz -C /opt/zap
          ZAPDIR=$(find /opt/zap -maxdepth 1 -type d -name 'ZAP_*' | head -n1)
          if [ -z "$ZAPDIR" ]; then
            echo "/opt/zap contents:" && ls -la /opt/zap
            exit 1
          fi
          echo "zap_dir=$ZAPDIR" >> "$GITHUB_OUTPUT"

      - name: Start ZAP daemon
        run: |
          set -euo pipefail
          ZAP_DIR=$(find /opt/zap -maxdepth 1 -type d -name 'ZAP_*' | head -n1)
          "$ZAP_DIR/zap.sh" -daemon -port 8090 -host 127.0.0.1 &
          for i in {1..30}; do
            if nc -z 127.0.0.1 8090 >/dev/null 2>&1; then
              echo "ZAP ready"
              break
            fi
            sleep 1
          done

      - name: Run ZAP scan
        run: |
          set -euo pipefail
          ZAP_DIR=$(find /opt/zap -maxdepth 1 -type d -name 'ZAP_*' | head -n1)
          FULLSCAN=$(find "$ZAP_DIR" -type f -name 'zap-full-scan.py' | head -n1 || true)
          if [ -z "$FULLSCAN" ]; then
            FULLSCAN=$(find "$ZAP_DIR" -type f -name 'zap-baseline.py' | head -n1 || true)
          fi
          if [ -z "$FULLSCAN" ]; then
            echo "No fullscan or baseline script found under $ZAP_DIR" && ls -la "$ZAP_DIR"
            exit 1
          fi
          python3 "$FULLSCAN" -t http://localhost:3000 -r "$GITHUB_WORKSPACE/zap-report/report.html"

      - name: Upload ZAP report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: zap-report
          path: "$GITHUB_WORKSPACE/zap-report"
