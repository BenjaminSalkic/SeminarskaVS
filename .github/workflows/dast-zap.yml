name: DAST - OWASP ZAP

on:
  workflow_dispatch:

jobs:
  zap_scan:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: '18'

      - name: Install deps
        run: npm ci

      - name: Start app
        run: npm start &

      - name: Wait for server
        run: |
          for i in {1..15}; do
            curl -sSf http://localhost:3000 && break || sleep 1
          done

      - name: Install tools
        run: |
          sudo apt-get update
          sudo apt-get install -y --no-install-recommends \
            openjdk-11-jre-headless wget tar gzip python3 python3-pip netcat-openbsd jq

      - name: Query releases and download ZAP
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          set -euo pipefail
          API_URL=https://api.github.com/repos/zaproxy/zaproxy/releases/latest
          http_code=$(curl -sS -H "Accept: application/vnd.github+json" -H "Authorization: Bearer $GITHUB_TOKEN" -w "%{http_code}" -o /tmp/releases.json "$API_URL" || true)
          if [ "$http_code" != "200" ]; then
            echo "GitHub API returned $http_code"
            head -c 400 /tmp/releases.json || true
            exit 1
          fi
          # Find any tar.gz asset (linux/unix) robustly even if JSON shape varies
          URL=$(jq -r '.. | objects | select(.name? and (.name|test("\\.tar\\.gz$";"i"))) | .browser_download_url' /tmp/releases.json | head -n1 || true)
          if [ -z "${URL:-}" ]; then
            echo "No tar.gz asset found in release JSON"
            # print possible asset names (robust fallback)
            jq -r '.. | objects | select(.name?) | .name' /tmp/releases.json | sed -n '1,200p' || true
            exit 1
          fi
          echo "Downloading $URL"
          curl -fSL -o /tmp/zap.tar.gz "$URL"
          sudo mkdir -p /opt/zap
          sudo tar -xzf /tmp/zap.tar.gz -C /opt/zap
          ZAPDIR=$(find /opt/zap -maxdepth 1 -type d -name 'ZAP_*' | head -n1)
          if [ -z "$ZAPDIR" ]; then
            echo "/opt/zap contents:" && ls -la /opt/zap
            exit 1
          fi
          echo "zap_dir=$ZAPDIR" >> "$GITHUB_OUTPUT"

      - name: Start ZAP daemon (with diagnostics)
        run: |
          set -euo pipefail
          ZAP_DIR=$(find /opt/zap -maxdepth 1 -type d -name 'ZAP_*' | head -n1)
          echo "Using ZAP dir: $ZAP_DIR"
          LOG="$GITHUB_WORKSPACE/zap.log"
          echo "Starting ZAP daemon, logging to $LOG"
          # Start ZAP with API key disabled (CI convenience) and log output
          nohup "$ZAP_DIR/zap.sh" -daemon -port 8090 -host 127.0.0.1 -config api.disablekey=true > "$LOG" 2>&1 &
          # Wait for the ZAP API to respond (try up to ~3 minutes)
          HTTP=000
          for i in {1..60}; do
            # attempt to call the core version API
            HTTP=$(curl -sS -o /tmp/zap_version.json -w "%{http_code}" --max-time 10 http://127.0.0.1:8090/JSON/core/view/version/ || true)
            if [ "$HTTP" = "200" ]; then
              echo "ZAP API responded (200)"
              cat /tmp/zap_version.json
              break
            fi
            echo "ZAP API not ready yet (http=$HTTP), sleeping..."
            sleep 3
          done
          if [ "$HTTP" != "200" ]; then
            echo "ZAP did not respond after waiting; dumping diagnostics"
            echo "--- /opt/zap listing ---"
            ls -la "$ZAP_DIR" || true
            echo "--- tail of zap.log ---"
            tail -n 200 "$LOG" || true
            echo "--- listening sockets ---"
            ss -ltnp || true
            echo "--- java processes ---"
            ps aux | grep java || true
            exit 1
          fi

      - name: Run ZAP scan
        run: |
          set -euo pipefail
          TARGET="http://localhost:3000"
          mkdir -p "$GITHUB_WORKSPACE/zap-report"
          echo "Triggering spider for $TARGET"
          SPIDER_JSON=$(curl -sS "http://127.0.0.1:8090/JSON/spider/action/scan/?url=$TARGET&recurse=true")
          SPIDER_ID=$(echo "$SPIDER_JSON" | jq -r '.scan // .scanId // empty')
          echo "Spider started, id=$SPIDER_ID"
          if [ -n "$SPIDER_ID" ]; then
            while true; do
              STATUS=$(curl -sS "http://127.0.0.1:8090/JSON/spider/view/status/?scanId=$SPIDER_ID" | jq -r '.status // .state // empty')
              echo "Spider status: $STATUS"
              [ "$STATUS" = "100" ] && break
              sleep 3
            done
          else
            echo "Warning: spider did not return an id, continuing"
          fi

          echo "Triggering active scan for $TARGET"
          ASCAN_JSON=$(curl -sS "http://127.0.0.1:8090/JSON/ascan/action/scan/?url=$TARGET&recurse=true")
          ASCAN_ID=$(echo "$ASCAN_JSON" | jq -r '.scan // .scanId // empty')
          echo "Active scan started, id=$ASCAN_ID"
          if [ -n "$ASCAN_ID" ]; then
            while true; do
              STATUS=$(curl -sS "http://127.0.0.1:8090/JSON/ascan/view/status/?scanId=$ASCAN_ID" | jq -r '.status // empty')
              echo "Active scan status: $STATUS"
              [ "$STATUS" = "100" ] && break
              sleep 5
            done
          else
            echo "Warning: active scan did not return an id, continuing"
          fi

          echo "Generating HTML report"
          curl -sS "http://127.0.0.1:8090/OTHER/core/other/htmlreport/" -o "$GITHUB_WORKSPACE/zap-report/report.html"
          echo "Report saved to $GITHUB_WORKSPACE/zap-report/report.html"

      - name: Upload ZAP report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: zap-report
          # Use the workflow expression so the runner expands the workspace path.
          # Also include a relative path fallback in case expansion behaves differently.
          path: |
            ${{ github.workspace }}/zap-report
            zap-report
