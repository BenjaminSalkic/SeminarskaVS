name: DAST - OWASP ZAP

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]
  workflow_dispatch:

jobs:
  zap_scan:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: '18'

      - name: Install dependencies
        run: npm ci

      - name: Start app
        run: npm start &

      - name: Wait for server
        run: |
          for i in {1..15}; do
            curl -sSf http://localhost:3000 && break || sleep 1
          done

      - name: Log in to Docker Hub
        uses: docker/login-action@v2
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      - name: Log in to GitHub Container Registry (GHCR)
        uses: docker/login-action@v2
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: "Debug: test docker pull"
        env:
          DOCKERHUB_USERNAME: ${{ secrets.DOCKERHUB_USERNAME }}
          DOCKERHUB_TOKEN: ${{ secrets.DOCKERHUB_TOKEN }}
        run: |
          echo "Docker version:" && docker --version || true
          echo "Attempt docker login (no secrets printed)"
          echo "$DOCKERHUB_TOKEN" | docker login --username "$DOCKERHUB_USERNAME" --password-stdin || true
          echo "Attempt test pull of ZAP image (GHCR)" && docker pull ghcr.io/zaproxy/zap2docker-stable:latest || true
      - name: Install JVM, Python and tools for ZAP
        run: |
          set -euo pipefail
          sudo apt-get update
          sudo apt-get install -y --no-install-recommends openjdk-11-jre-headless wget tar gzip python3 python3-pip netcat-openbsd

      - name: Download and extract ZAP release
        run: |
          set -euo pipefail
          echo "Querying GitHub releases for zaproxy/zaproxy to find a unix tarball asset"
          # Use authenticated API request to avoid low unauthenticated rate limits
          REPO_API="https://api.github.com/repos/zaproxy/zaproxy/releases/latest"
          HTTP_STATUS=$(curl -sS -o /tmp/releases.json -w "%{http_code}" -H "Accept: application/vnd.github+json" -H "Authorization: Bearer ${{ secrets.GITHUB_TOKEN }}" "$REPO_API" || true)
          if [ "$HTTP_STATUS" != "200" ]; then
            echo "ERROR: GitHub API returned HTTP $HTTP_STATUS"
            echo "Response (first 400 chars):"
            head -c 400 /tmp/releases.json || true
            echo
            exit 1
          fi
          # Find unix tarball asset URL from the release JSON
          URL=$(python3 - <<'PY'
import sys, json
data = json.load(open('/tmp/releases.json'))
for a in data.get('assets', []):
    name = a.get('name','')
    if 'unix' in name and name.endswith('.tar.gz'):
        print(a.get('browser_download_url'))
        sys.exit(0)
sys.exit(1)
PY
)
          if [ -z "${URL:-}" ]; then
            echo "ERROR: could not find a unix tar.gz asset in zaproxy release assets" >&2
            echo "Release JSON assets list:" && jq -r '.assets[].name' /tmp/releases.json || true
            exit 1
          fi
          echo "Found asset URL: $URL"
          curl -fSL --retry 3 --retry-delay 2 -o /tmp/zap.tar.gz "$URL"
          echo "Extracting to /opt/zap"
          sudo mkdir -p /opt/zap
          sudo tar -xzf /tmp/zap.tar.gz -C /opt/zap
          ZAPDIR=$(find /opt/zap -maxdepth 1 -type d -name 'ZAP_*' | head -n1)
          if [ -z "$ZAPDIR" ]; then
            echo "ERROR: extracted ZAP directory not found" >&2
            ls -la /opt/zap
            exit 1
          fi
          echo "ZAP extracted to: $ZAPDIR"
          echo "zap_dir=$ZAPDIR" >> "$GITHUB_OUTPUT"

      - name: Start ZAP daemon
        run: |
          set -euo pipefail
          ZAP_DIR=$(find /opt/zap -maxdepth 1 -type d -name 'ZAP_*' | head -n1)
          echo "Using ZAP dir: $ZAP_DIR"
          mkdir -p "$GITHUB_WORKSPACE/zap-report"
          # start zap in daemon mode on port 8090
          "$ZAP_DIR/zap.sh" -daemon -port 8090 -host 127.0.0.1 &
          # wait for ZAP to be ready
          for i in {1..30}; do
            if nc -z 127.0.0.1 8090 >/dev/null 2>&1; then
              echo "ZAP daemon is listening"
              break
            fi
            sleep 1
          done

      - name: Run ZAP full scan (python script)
        run: |
          set -euo pipefail
          ZAP_DIR=$(find /opt/zap -maxdepth 1 -type d -name 'ZAP_*' | head -n1)
          echo "Looking for zap-full-scan.py under $ZAP_DIR"
          FULLSCAN=$(find "$ZAP_DIR" -type f -name 'zap-full-scan.py' | head -n1 || true)
          if [ -z "$FULLSCAN" ]; then
            echo "zap-full-scan.py not found, attempting to use zap-baseline.py"
            FULLSCAN=$(find "$ZAP_DIR" -type f -name 'zap-baseline.py' | head -n1 || true)
          fi
          if [ -z "$FULLSCAN" ]; then
            echo "ERROR: no ZAP full-scan script found under $ZAP_DIR" >&2
            exit 1
          fi
          echo "Using full-scan script: $FULLSCAN"
          python3 "$FULLSCAN" -t http://localhost:3000 -r "$GITHUB_WORKSPACE/zap-report/report.html"

      - name: Upload ZAP report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: zap-report
          path: "./"
