name: DAST - OWASP ZAP

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]
  workflow_dispatch:

jobs:
  zap_scan:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: '18'
      - name: Install dependencies
        run: npm ci
      - name: Start app
        run: npm start &
      - name: Wait for server
        run: |
          for i in {1..15}; do curl -sSf http://localhost:3000 && break || sleep 1; done
      - name: Log in to Docker Hub
        uses: docker/login-action@v2
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}
      - name: Log in to GitHub Container Registry (GHCR)
        uses: docker/login-action@v2
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}
      - name: "Debug: test docker pull"
        env:
          DOCKERHUB_USERNAME: ${{ secrets.DOCKERHUB_USERNAME }}
          DOCKERHUB_TOKEN: ${{ secrets.DOCKERHUB_TOKEN }}
        run: |
          echo "Docker version:" && docker --version || true
          echo "Attempt docker login (no secrets printed)" && echo "$DOCKERHUB_TOKEN" | docker login --username "$DOCKERHUB_USERNAME" --password-stdin || true
          echo "Attempt test pull of ZAP image (GHCR)" && docker pull ghcr.io/zaproxy/zap2docker-stable:latest || true
      - name: Install JVM, Python and tools for ZAP
        run: |
          set -euo pipefail
          sudo apt-get update
          sudo apt-get install -y openjdk-11-jre-headless wget tar gzip python3 python3-pip netcat-openbsd

      - name: Download and extract ZAP release
        env:
          ZAP_VERSION: "2.12.0"
        run: |
          set -euo pipefail
          VER=${ZAP_VERSION}
          VER_US=${VER//./_}
          echo "Downloading ZAP v${VER}"
          URL="https://github.com/zaproxy/zaproxy/releases/download/v${VER}/ZAP_${VER_US}_unix.tar.gz"
          echo "Using URL: $URL"
          wget -q -O /tmp/zap.tar.gz "$URL"
          mkdir -p /opt/zap
          tar -xzf /tmp/zap.tar.gz -C /opt/zap
          # find extracted dir
          ZAPDIR=$(find /opt/zap -maxdepth 1 -type d -name 'ZAP_*' | head -n1)
          if [ -z "$ZAPDIR" ]; then
            echo "ERROR: extracted ZAP directory not found" >&2
            ls -la /opt/zap
            exit 1
          fi
          echo "ZAP extracted to: $ZAPDIR"
          echo "zap_dir=$ZAPDIR" >> "$GITHUB_OUTPUT"

      - name: Start ZAP daemon
        run: |
          set -euo pipefail
          ZAP_DIR=$(find /opt/zap -maxdepth 1 -type d -name 'ZAP_*' | head -n1)
          echo "Using ZAP dir: $ZAP_DIR"
          mkdir -p "$GITHUB_WORKSPACE/zap-report"
          # start zap in daemon mode on port 8090
          "$ZAP_DIR/zap.sh" -daemon -port 8090 -host 127.0.0.1 &
          # wait for ZAP to be ready
          for i in {1..30}; do
            if nc -z 127.0.0.1 8090 >/dev/null 2>&1; then
              echo "ZAP daemon is listening"
              break
            fi
            sleep 1
          done

      - name: Run ZAP full scan (python script)
        run: |
          set -euo pipefail
          ZAP_DIR=$(find /opt/zap -maxdepth 1 -type d -name 'ZAP_*' | head -n1)
          echo "Looking for zap-full-scan.py under $ZAP_DIR"
          FULLSCAN=$(find "$ZAP_DIR" -type f -name 'zap-full-scan.py' | head -n1 || true)
          if [ -z "$FULLSCAN" ]; then
            echo "zap-full-scan.py not found, attempting to use zap-baseline.py"
            FULLSCAN=$(find "$ZAP_DIR" -type f -name 'zap-baseline.py' | head -n1 || true)
          fi
          if [ -z "$FULLSCAN" ]; then
            echo "ERROR: no ZAP full-scan script found under $ZAP_DIR" >&2
            exit 1
          fi
          echo "Using full-scan script: $FULLSCAN"
          python3 "$FULLSCAN" -t http://localhost:3000 -r "$GITHUB_WORKSPACE/zap-report/report.html"
      - name: Upload ZAP report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: zap-report
          path: "./"
